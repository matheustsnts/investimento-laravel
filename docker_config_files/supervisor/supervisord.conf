[supervisord]
logfile=/var/log/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor/
user=root
nodaemon=true

; ============================================================
; Grupo para gerenciar todos os processos Laravel
; ============================================================
[group:laravel]
programs=laravel-queue,laravel-schedule
priority=100

; ============================================================
; Worker de filas
; ============================================================
[program:laravel-queue]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/artisan queue:work --sleep=3 --tries=3 --timeout=90
autostart=true
autorestart=true
user=www-data
numprocs=1
redirect_stderr=true
stdout_logfile=/var/www/storage/logs/queue.log
stopwaitsecs=3600
environment=HOME="/var/www",APP_ENV="local"

; ============================================================
; Scheduler - modo "work" (processo contínuo)
; Se preferir usar cron, desative este bloco e ative o bloco [program:cron]
; ============================================================
[program:laravel-schedule]
command=php /var/www/artisan schedule:work
autostart=true
autorestart=true
user=www-data
redirect_stderr=true
stdout_logfile=/var/www/storage/logs/schedule.log
stopwaitsecs=3600
environment=HOME="/var/www",APP_ENV="local"

; ============================================================
; Opcional: se preferir cron + schedule:run (comente laravel-schedule acima)
; Para usar, descomente o bloco abaixo e adicione um arquivo crontab no container,
; por exemplo /etc/cron.d/laravel-cron contendo:
; * * * * * cd /var/www && /usr/bin/php artisan schedule:run >> /var/www/storage/logs/scheduler-cron.log 2>&1
; ============================================================
[program:cron]
command=/usr/sbin/cron -f
autostart=true
autorestart=true
user=root
redirect_stderr=true
stdout_logfile=/var/www/storage/logs/cron.log

; ============================================================
; Opcional: monitor / healthcheck (exemplo simples)
; Você pode adicionar scripts que checam a existência de processos, endpoints, etc.
; Exemplo comentado:
; ============================================================
[program:healthcheck]
command=/usr/bin/php /var/www/artisan health:check
autostart=true
autorestart=true
user=www-data
redirect_stderr=true
stdout_logfile=/var/www/storage/logs/healthcheck.log